---
title: "ASICS User's Guide"
author: "Gaëlle Lefort, Rémi Sevien, Patrick Tardivel and Nathalie Villa-Vialaneix"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document2:
    toc_float: true
vignette: |
  %\VignetteIndexEntry{ASICS}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---


This user's guide provides an overview of the package `ASICS`. `ASICS` is a 
fully automated procedure to identify and quantify metabolites in $^1$H 1D-NMR 
spectra of biological mixtures. It will enable empowering NMR-based metabolomics
by quickly and accurately helping experts to obtain metabolic profiles. In this
package, in addition to this method, several functions allowing spectrum 
preprocessing or quantification analyses are available.

```{r ASICSload}
library(ASICS)
```

TODO: note sur le parallèle

# Context/Data

TODO: voir d'abord si toute l'analyse est faisable sans pb sur ce jeu de données.

Parler aussi de ASICS (reference à l'article). ici ?

# Library of pure NMR metabolite spectra

An object of class `PureLibrary` with spectra of 180 pure metabolites is 
available in the package. It is used for quantification. Indeed, only 
metabolites present in the library object can be quantify with ASICS.

The default one is automatically loaded at package start and available 
metabolites are displayed with:
```{r lib}
head(get_sample_name(pure_library), n = 8)
```

It is possible to complete this library or create another one. Pure spectra can 
be imported from Bruker files and a new library can be created with:
```{r import_create_lib, results='hide'}
pure_spectra <- import_spectra_bruker(system.file("extdata", "example_library", 
                                                  package = "ASICS"))
new_pure_library <- create_pure_library(pure_spectra, 
                                        nb.protons = c(5, 4, 9, 9))
```
New library can also be created from txt or csv file, it is just necessary to 
obtain a data frame with samples in colums and chemical shifts in rows (see 
help page of `create_pure_library` function for all details).


Newly created library can be used for quantification or merge with another one:
```{r select_merge_lib}
merged_pure_library <- c(pure_library[1:10], new_pure_library)
```
The `PureLibrary` `merged_pure_library` contains the first ten spectra of 
default library and the four spectra imported above.



# Identification and quantification of metabolites on Bruker files with ASICS

First, data are imported in a data frame from Bruker files with the 
`import_spectra_bruker` function. These spectra are baseline corrected 
(Wang *et al*, 2013) and normalised by the area under the curve.
```{r import_from_Bruker, results='hide'}
spectra_data <- import_spectra_bruker(system.file("extdata", 
                                                  "Human_diabetes_example", 
                                                  package = "ASICS"))
```

It also possible to import data from other file types with usual `R` function. 
The only constraint is to have a data frame with spectra in colums 
(colnames are sample names) and chemical shifts in rows (rownames correspond to 
the ppm grid).
```{r import_from_txt, results='hide'}
spectra_data_txt <- 
  read.table(system.file("extdata", "spectra_diabetes_example.txt",
                         package = "ASICS"), header = TRUE, row.names = 1)
```

Several functions for the preprocessing of spectra are also available: baseline 
correction, normalisation by the AUC and alignment (Vu et al., 2011)
```{r preprocessing, results='hide'}
spectra_base_cor <- baseline_correction(spectra_data_txt)
spectra_align <- alignment(spectra_base_cor)
spectra_norm <- normalisation(spectra_align)
```
Note than a normalisation by the area under the curve is included in the 
baseline correction and alignment functions. Moreover, baseline correction and
normalisation are also included in the `import_spectra_bruker` function.


Finally, from the data frame, a `Spectra` object is created. This is a required 
step for the quantification.
```{r create_spectra, results='hide'}
spectra_obj <- create_spectra(spectra_align)
```

--- ok jusqu'ici


It is now possible to carry out the identification and quantification using only 
the function `ASICS`. This function can take some times (about 1min30 by 
spectrum) thus, execpt on Windows, a parallel environment with the number of 
CPU cores on the current host - 2 is created by default. This also applies for 
data import. If you don't want a parallel environment, you can set `parallel` 
parameter to `FALSE`.
```{r ASICS, results='hide', cache = TRUE, dependson='import_from_Bruker'}
# part of the spectrum to exclude (water and urea)
to_exclude <- matrix(c(4.5, 5.1, 5.5, 6.5), ncol = 2, byrow = TRUE)
system.time(ASICS_results <- ASICS(spectra_obj[1], exclusion.areas = to_exclude))
```

Summary of ASICS results:
```{r summary_res}
ASICS_results
```


The quality of the results can be assessed by stacking the original and 
the recomposed spectra on one plot. A pure metabolite spectrum can also be 
added for visual comparison. For example, the first spectrum with Lactate:
```{r plot_spectrum, warning=FALSE, fig.width=12, fig.height=8}
plot_spectrum(ASICS_results, idx = 1, xlim = c(1, 1.5), add.metab = "Lactate")
```

Relative concentrations of identified metabolites are saved in a data frame
accessible via the `get_quantification` function:
```{r rel_conc}
head(get_quantification(ASICS_results), 10)[, 1:2]
```

# Analysis on quantification (PCA, OPLS/OPLS-DA and tests)



```{r}
design <- read.table(system.file("extdata", "design_diabete_example.txt", 
                                 package = "ASICS"), header = TRUE)
```


```{r}
analysis_data <- format_for_analysis(get_quantification(ASICS_results),
                                     design = design, zero.threshold = 0.5, 
                                     outliers = c("ADG10003u_007", "ADG19007u_163"))
```


PCA : 
```{r, fig.width=10}
resPCA <- PCA(analysis_data)
plot_PCA(resPCA, graph = "ind", col.ind = "condition")
plot_PCA(resPCA, graph = "var")
```


OPLS-DA:
```{r}
resOPLSDA <- OPLSDA(analysis_data, condition = "condition")
plot_OPLSDA(resOPLSDA)
```

Tests:
```{r}
kruskal_on_quantification(analysis_data, "condition")
```




# References 


Tardivel P., Canlet C., Lefort G., Tremblay-Franco M., Debrauwer L., Concordet 
D., Servien R. (2017). ASICS: an automatic method for identification and 
quantification of metabolites in complex 1D 1H NMR spectra. *Metabolomics*,
**13**(10): 109. https://doi.org/10.1007/s11306-017-1244-5

Wang, K. C., Wang, S. Y., Kuo, C. H., Tseng, Y. J. (2013). Distribution-based 
classification method for baseline correction of metabolomic 1D proton nuclear 
magnetic resonance spectra. *Analytical Chemistry*, **85**(2), 1231–1239.

Vu, T. N., Valkenborg, D., Smets, K., Verwaest, K. A., Dommisse, R., Lemiere, 
F., ... & Laukens, K. (2011). An integrated workflow for robust alignment and 
simplified quantitative analysis of NMR spectrometry data. 
*BMC bioinformatics*, **12**(1), 405.
# Session information

This user's guide has been created with the following system configuration
```{r sysinfo}
sessionInfo()
```

