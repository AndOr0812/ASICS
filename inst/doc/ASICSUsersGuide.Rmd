---
title: "ASICS User's Guide"
author: "Gaëlle Lefort"
date: "`r Sys.Date()`"
output:
  BiocStyle::html_document2:
    toc_float: true
vignette: |
  %\VignetteIndexEntry{ASICS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


This user's guide provides an overview of the package `ASICS`. `ASICS` is a 
fully automated procedure to identify and quantify metabolites in $^1$H NMR 
spectra of biological mixtures. It will enable empowering NMR-based metabolomics
by quickly and accurately helping experts to obtain metabolic profiles.

```{r ASICSload}
library(ASICS)
```

# Library of pure NMR metabolite spectra

An object of class `PureLibrary` with spectra of 175 pure metabolites is 
available in the package. It is automatically loaded at package start and 
available metabolites are displayed with:
```{r lib}
head(get_sample_name(pure_library), n = 20)
```

Pure spectra can be imported from Bruker files and a new library can be created
with:
```{r import_create_lib, results='hide'}
pure_spectra <- import_spectra_bruker(system.file("extdata", "example_library", 
                                                  package = "ASICS"))
new_pure_library <- create_pure_library(pure_spectra, nb.protons = c(5,4,9,9))
```

New library can be used for quantification or merge with another one:
```{r select_merge_lib}
merged_pure_library <- c(pure_library[1:10], new_pure_library)
```
The `PureLibrary` `merged_pure_library` contains the first ten spectra of 
default library and the four spectra imported above.



# Identification and quantification of metabolites on Bruker files with ASICS

First, data are imported in a data frame from Bruker files with the 
`import_spectra_bruker` function. It also possible to import data from other 
file types with usual `R` function. The only constraint is to have a data frame 
with spectra in colums (colnames are sample names) and chemical shifts in rows 
(rownames correspond to the ppm grid).
```{r import_from_Bruker, results='hide'}
spectra_data <- import_spectra_bruker(system.file("extdata", "brain_mice", 
                                                  package = "ASICS"))
```

Then, from the data frame, a `Spectra` object is created. In this object, 
spectra are baseline corrected (Wang *et al*, 2013) and normalised by the area 
under the curve. This is required step for the quantification.
```{r create_spectra, results='hide'}
spectra_obj <- preprocessing_spectra(spectra_data)
```

It is now possible to carry out the identification and quantification using only 
the function `ASICS`:
```{r ASICS, results='hide', cache = TRUE}
# part of the spectrum to exclude (water)
to_exclude <- matrix(c(4.5,5.1,5.5,6.5), ncol = 2, byrow = TRUE)
ASICS_results <- ASICS(spectra_obj, exclusion.areas = to_exclude)
```

Summary of ASICS results:
```{r summary_res}
ASICS_results
```


The quality of the results can be assessed by stacking the original and 
the recomposed spectra on one plot. A pure metabolite spectrum can also be 
added for visual comparison. For example, the first spectrum with Lactate:
```{r plot_spectrum, warning=FALSE, fig.width=12, fig.height=8}
plot_spectrum(ASICS_results, idx = 1, xlim = c(1, 1.5), add.metab = "Lactate")
```

Relative concentrations of identified metabolites are saved in a data frame:
```{r rel_conc}
head(get_quantification(ASICS_results), 10)[, 1:3]
```



# Reference 

Tardivel P., Canlet C., Lefort G., Tremblay-Franco M., Debrauwer L., Concordet 
D., Servien R. (2017). ASICS: an automatic method for identification and 
quantification of metabolites in complex 1D 1H NMR spectra. *Metabolomics*,
**13**(10): 109. https://doi.org/10.1007/s11306-017-1244-5

Wang, K. C., Wang, S. Y., Kuo, C. H., Tseng, Y. J. (2013). Distribution-based 
classification method for baseline correction of metabolomic 1D proton nuclear 
magnetic resonance spectra. *Analytical Chemistry*, **85**(2), 1231–1239.


# Session information

This user's guide has been created with the following system configuration
```{r sysinfo}
sessionInfo()
```

